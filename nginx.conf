user  gateway;
worker_processes  8;
env UVE_DEBUG_LOGFILE=1;

error_log  /data1/nginx/logs/error.log  debug;

pid        /data1/nginx/logs/nginx.pid;

worker_rlimit_nofile 65535;

events {
    use epoll;
    worker_connections  65535;
}

http {

    resolver 180.149.139.249 123.125.105.252;
    resolver_timeout 50ms;

    include       mime.types;
    default_type  application/octet-stream;
    server_tokens off;

    server_names_hash_bucket_size 128;
    client_header_buffer_size 4k;
    large_client_header_buffers 4 32k;
    client_max_body_size 100m;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" $request_body '
    '^$status^ $body_bytes_sent "$http_referer" '
    '"$http_user_agent" "$http_x_forwarded_for" ^"$request_time"^ "^$upstream_response_time^"';
    log_format sub_request '[$time_local] $uri $status $request_time [$upstream_addr] [$upstream_response_time] [$upstream_status]';
    log_format sub_request_args '[$time_local] $uri $status $request_time [$upstream_addr] [$upstream_response_time] [$upstream_status] $args';

    sendfile       on;
    tcp_nopush     on;
    tcp_nodelay    on;
    keepalive_timeout  30;

    gzip  on;
    gzip_min_length  1k;
    gzip_buffers     4 16k;
    gzip_http_version 1.0;
    gzip_comp_level 9;
    gzip_types       text/plain application/x-javascript text/css application/xml;
    gzip_vary on;

    fastcgi_connect_timeout 60;
    fastcgi_send_timeout 60;
    fastcgi_read_timeout 60;
    fastcgi_buffer_size 128k;
    fastcgi_buffers 8 128k;
    fastcgi_busy_buffers_size 256k;
    fastcgi_temp_file_write_size 256k;

    server {
        listen       80;
        server_name  localhost local;

        root /data0/uve_service_tests;
        index index.php;

        #charset koi8-r;

        access_log  logs/localhost.access.log  main;

        location / {
            if (!-e $request_filename) {
                rewrite ^/(.*)$ /rewrite_index.php/$1 last;
            }
        }

        location = / {
            rewrite ^/(.*)$ /rewrite_index.php/$1 last;
        }

        location ~ ^/test/ {
            rewrite ^/test/(.*)$ /t.php/$1 last;
        }
        
        location ~ \.php($|/) {
            fastcgi_pass  127.0.0.1:9099;
            fastcgi_split_path_info ^(.+?\.php)(/.*)$;
            fastcgi_index  index.php;
            #fastcgi_param  SCRIPT_FILENAME  $document_root/$fastcgi_script_name;
            fastcgi_param  SCRIPT_FILENAME  $request_filename;
            fastcgi_param  PATH_INFO   $fastcgi_path_info;
            include        fastcgi_params;
        }
    }

    server {
        listen 8080;
        server_name localhost;

        root /data1/nginx/htdocs/phpMyAdmin-4.5.2-all-languages/;
        
        index index.php;
        
        location ~ \.php$ {
            fastcgi_pass  127.0.0.1:9099;
            fastcgi_index  index.php;
            fastcgi_param  SCRIPT_FILENAME  $document_root/$fastcgi_script_name;
            include        fastcgi_params;
        }
    }

    server {
        listen 80;
        server_name uve.intra.mobile.sina.cn;

        access_log  /data1/nginx/logs/access.log main;
        root /data1/nginx/htdocs;
        index index.php;
        
        location / {
            rewrite ^/$ /uvewiki/ last;
        }

        location ~ ^/uvewiki/(.*)\.php {
            root /data1/nginx/htdocs;

            fastcgi_pass  127.0.0.1:9000;
            fastcgi_index  index.php;
            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
            include        fastcgi_params;

            allow 10.0.0.0/8;
            allow 172.0.0.0/8;
            deny all;
        }

        location ~ ^/uvewiki/($|.*\.php) {
            index index.php;
            fastcgi_pass  127.0.0.1:9000;
            fastcgi_index  index.php;
            fastcgi_param  SCRIPT_FILENAME  $document_root/$fastcgi_script_name;
            include        fastcgi_params;
        }

        location ~ ^/videocallback/($|.*\.php) {
            index index.php;
            fastcgi_pass  127.0.0.1:9000;
            fastcgi_index  index.php;
            fastcgi_param  SCRIPT_FILENAME  $document_root/$fastcgi_script_name;
            include        fastcgi_params;
        }
    }

    server {
        listen       80;     
        server_name  data.uve.mobile.sina.cn;
        root /data1/nginx/htdocs/uve_data_center/public;
        index index.php;

        access_log  /data1/nginx/logs/dc.uve.pw_access.log  main;
        allow 10.0.0.0/8;
        allow 172.0.0.0/8;
        deny all;

        location ~* /\.svn/ {
            deny all;
        }       

        location ~ ^/uvedv/ {
            fastcgi_pass  127.0.0.1:9000;
            root /data0/linhua/uvewebm;
            fastcgi_index  index.php;
            fastcgi_param  SCRIPT_FILENAME  $document_root/$fastcgi_script_name;
            include        fastcgi_params;
        }       
        
        location / {
            try_files $uri $uri/ /index.php?$query_string;
        }

        location ~ \.php$ {
            fastcgi_pass  127.0.0.1:9099;
            fastcgi_index  index.php;
            fastcgi_param  SCRIPT_FILENAME  $document_root/$fastcgi_script_name;
            include        fastcgi_params;
        }       

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;   
        }       
    }
    server {
        listen       80; 
        server_name  webgrind.uve.pw;
        auth_basic           "Restricted";
        auth_basic_user_file /data0/nginx/nginx_password;
        root /data0/linhua/uvewebm/webgrind;
        index index.php;

        access_log  /data0/nginx/logs/webgrind.sap.weibo.com_access.log  main;

        location ~* /\.svn/ {
            deny all;
        }   

        location ~ \.php$ {
            fastcgi_pass  127.0.0.1:9000;
            fastcgi_index  index.php;
            fastcgi_param  SCRIPT_FILENAME  $document_root/$fastcgi_script_name;
            include        fastcgi_params;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }   
    }

    server {
        listen       80;
        server_name  mc.sap.weibo.com mc.s.uve.pw;
        auth_basic           "Restricted";
        auth_basic_user_file /data0/nginx/nginx_password;
        root /data0/nginx/htdocs/memcachedadmin;
        index index.php;

        access_log  /data0/nginx/logs/mc.sap.weibo.com_access.log  main;

        location ~* /\.svn/ {
            deny all;
        }

        location ~ \.php$ {
            fastcgi_pass  127.0.0.1:9000;
            fastcgi_index  index.php;
            fastcgi_param  SCRIPT_FILENAME  $document_root/$fastcgi_script_name;
            include        fastcgi_params;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }

    server {
        listen       80;
        server_name  test.uve.pw;
        root /data0/uve_service_tests;

        access_log  /data0/nginx/logs/uve_tests_access.log  main;

        location ~* /\.svn/ {
            deny all;
        }

        location / {
            if (!-e $request_filename) {
                rewrite ^/(.*)$ /rewrite_index.php/$1 last;
            }
        }

        location = / {
            rewrite ^/(.*)$ /rewrite_index.php/$1 last;
        }

        location ~ ^/admin/(.*)$ {
            rewrite ^/admin/(.*)$ /rewrite_index.php/$1 last;
        }

        location ~ \.php(/.*|$) {
            fastcgi_pass  127.0.0.1:9000;
            fastcgi_index  index.php;
            fastcgi_param  SCRIPT_FILENAME  $document_root/$fastcgi_script_name;
            include        fastcgi_params;
            fastcgi_param  REQUEST_URI $1;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }

    server {
        listen 80;
        server_name testclient1.ads.uve.pw testclient2.ads.uve.pw;
        root /data0/nginx/htdocs/testclient1;
        index index.php;

        location ~ \.php(/.*|$) {
            fastcgi_pass  127.0.0.1:9000;
            fastcgi_index  index.php;
            fastcgi_param  SCRIPT_FILENAME  $document_root/$fastcgi_script_name;
            include        fastcgi_params;
            fastcgi_param  REQUEST_URI $1;
        }
    }

    server {
        listen       80;
        server_name grafana.mobile.weibo.cn;
        location ~ ^/(.*)$ {
            proxy_pass http://10.77.96.56:3000/$1?$args;
            proxy_http_version 1.1;
            proxy_set_header Accept-Encoding '';
            proxy_set_header Connection "";
            proxy_connect_timeout 100000ms;
            proxy_send_timeout 20000ms;
            proxy_read_timeout 20000ms;
        }
    }

    server {
        listen       8070;
        server_name api.biz.weibo.com;
        root /data0/nginx/htdocs/adsapi/api;
        location / {
            index index.html;
        }
    }

    server {
        listen       8090;
        server_name developers.biz.weibo.com;
        root /data0/nginx/htdocs/adsapi/developers;
        location / {
            index index.html;
        }
    }

    lua_package_path "/usr/local/lib/lua/resty/?.lua;/data1/nginx/htdocs/uve_core/comm/lua_modules/?.lua;;";
    include /data1/nginx/htdocs/uve_core/conf/nginx_uve_init_worker.conf;
    include /data1/nginx/htdocs/uve_core/conf/nginx_uve_server.conf;


}
